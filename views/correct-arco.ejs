<div class="content-wrapper">
    <div class="row">
        <div class="col-md-12 grid-margin">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                <h4 class="font-weight-bold mb-0">Programmes <i class="ti-angle-right"></i> Correct ARCO</h4>
                </div>
                <div>
                    <!-- <button type="button" class="btn btn-primary btn-icon-text btn-rounded">
                    <i class="ti-clipboard btn-icon-prepend"></i>Report
                    </button> -->
                </div>
            </div>
        </div>
    </div>
    <div class="card" style="min-height: 650px;">
        <form action="/upload-correct-arco" enctype="multipart/form-data" method="post">
            <div class="row">
                <div class="col-md-6">
                    <div class="card-body">
                        <h4 class="card-title text-dark">The file that contains all the data to be copied in the ARCO Salaries file.</h4>
                    </div>
                    <!-- RH FILE -->
                    <div class="card-body">
                        <h4 class="card-title">Arco Report With Correction Factor Related To Different Shifts</h4>
                        <p class="card-description">Field to upload <code>ARCO Reporting</code> files. </p>
                        <div class="template-demo">
                            <div class="form-group">
                                <input type="file" name="arco-report" id="arco-report-0" class="file-upload-default arco-report" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <div class="input-group col-xs-12">
                                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                                    <button class="file-upload-browse btn btn-primary text-white" type="button" onclick="uploadClick(this, 'arco-report-0')">
                                        <i class="ti-file btn-icon-prepend"></i>
                                        Upload file
                                    </button>
                                    <button class="btn btn-info text-white" type="button" onclick="deleteARCOField(this)">
                                        <i class="ti-trash"></i>
                                    </button>
                                </div>
                                <select class="form-control mt-1" style="display: none;" id="arco-report-sheetname">
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="file" name="arco-report" id="arco-report-1" class="file-upload-default arco-report" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <div class="input-group col-xs-12">
                                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                                    <button class="file-upload-browse btn btn-primary text-white" type="button" onclick="uploadClick(this, 'arco-report-1')">
                                        <i class="ti-file btn-icon-prepend"></i>
                                        Upload file
                                    </button>
                                    <button class="btn btn-info text-white" type="button" onclick="deleteARCOField(this)">
                                        <i class="ti-trash"></i>
                                    </button>
                                </div>
                                <select class="form-control mt-1" style="display: none;" id="arco-report-sheetname">
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="file" name="arco-report" id="arco-report-2" class="file-upload-default arco-report" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <div class="input-group col-xs-12">
                                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                                    <button class="file-upload-browse btn btn-primary text-white" type="button" onclick="uploadClick(this, 'arco-report-2')">
                                        <i class="ti-file btn-icon-prepend"></i>
                                        Upload file
                                    </button>
                                    <button class="btn btn-info text-white" type="button" onclick="deleteARCOField(this)">
                                        <i class="ti-trash"></i>
                                    </button>
                                </div>
                                <select class="form-control mt-1" style="display: none;" id="arco-report-sheetname">
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-info text-white" type="button" onclick="addARCOField(this)">
                                    <i class="ti-plus"></i> New field
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-body">
                        <h4 class="card-title text-dark">The files in which we will copy the data.</h4>
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">ARCO SALARIES WORKINGS</h4>
                        <p class="card-description">Field to upload <code>ARCO Salaries</code> files.</p>
                        <div class="template-demo">
                            <div class="form-group">
                                <input type="file" name="arco-salary" id="arco-salary" class="file-upload-default" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <div class="input-group col-xs-12">
                                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                                    <button class="file-upload-browse btn btn-dark text-white" type="button" role="button" onclick="uploadClick(this, 'arco-salary')">
                                        <i class="ti-file btn-icon-prepend"></i>
                                        Upload file
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div id="warnings" class="card-body" style="display: none;">
                        <table class="table table-border">
                            <tbody id="warning-field">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="card-body">
                        <hr>
                        <h4 class="card-title"></h4>
                        <div class="template-demo text-center">
                            <p class="text-muted">Click on the button below to start <code>The correction</code> and <code>Download</code> the Excel file.</p>
                            <p class="text-muted">But before that, make sure that you have uploaded at least a file for each columns.</p>
                            <button type="submit" role="button" class="btn btn-success text-white btn-icon-text" id="download">
                                <i class="ti-download btn-icon-prepend"></i>                                                    
                                Start Correction and Download the file
                            </button>
                            <div class="text-center">
                                <small class="mt-2 text-muted" style="display: block;" id="downloading-p"></small>
                                <img src="/images/loading-gif-15.gif" alt="loading..." draggable="false" id="loading-gif" style="width: 110px;opacity: 0;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script src="/js/sweetalert.min.js"></script>
    <script src="/js/exceljs.min.js"></script>
    <script src="../node_modules/socket.io/client-dist/socket.io.js"></script>
    <script>
        var socket = io.connect();
        socket.on('connection');
        // ACTION
        socket.on('action', message => {
            console.log(message);
            downloadingP.textContent = message;
        });

        // ERROR
        socket.on('error', data => {
            swal({
                title: new String(data.icon).toUpperCase(),
                text: data.message,
                icon: data.icon,
            });

            document.getElementById('warning-field').innerHTML = '';
            // show warning
            if (Array.isArray(data.warnings) && data.warnings.length > 0) {
                warnings.style.display = 'block';
                data.warnings.forEach((warn, index) => {
                document.getElementById('warning-field').innerHTML += `
                <tr class="table-${warn.icon}">
                        <td>Warning: ${warn.message}</td>
                    </tr>`; 
                });
            }
            downloadBtn.disabled = false;
            loadingGif.style.opacity = '0';
            downloadingP.textContent = '';
        });
        
        // DOWNLOAD
        socket.on('download', data => {
            var link = document.createElement("A");
            link.setAttribute("href", '/' + data.file);
            link.setAttribute("style","display:none");
            link.setAttribute("download",data.file);
            document.body.appendChild(link);                                                        //needed for firefox
            link.click();
            // hide loading gif and remove link.
            // downloadingP.textContent = 'Downloading...';
            setTimeout(() => {
                downloadingP.textContent = '';
                downloadBtn.disabled = false;
                loadingGif.style.opacity = '0';
                link.remove();
            }, 3000);
        });
    </script>
    <script>
        let downloadBtn = document.getElementById('download');
        let loadingGif = document.getElementById('loading-gif');
        let downloadingP = document.getElementById('downloading-p');
        let warnings = document.getElementById('warnings');
        var fileSelecteds = [];

        function uploadClick(btn, id) {
            let inputfile = document.getElementById(id);
                inputfile.addEventListener('change', () => {})
            if (inputfile) {
                inputfile.click();
                inputfile.addEventListener('change', (e) => {
                    if (btn.previousElementSibling && btn.previousElementSibling.className === 'btn btn btn-inverse-danger btn-fw reset') {
                        btn.previousElementSibling.remove();
                    }
                    if (inputfile.files.length > 0) {
                        let btnR = document.createElement('button');
                        btnR.className = 'btn btn btn-inverse-danger btn-fw reset';
                        let i = document.createElement('i');
                        i.className = 'ti-share-alt btn-icon-prepend';
                        btnR.append(i);
                        btnR.append(document.createTextNode(' Reset'));
                        // btnR.setAttribute('onclick')
                        btnR.addEventListener('click', function(e) {
                            btnR.remove();
                            document.getElementById(id).value = null;
                            document.getElementById(id).files = null;
                            btn.parentElement.firstElementChild.value = '';
                            if (btn.parentElement.nextElementSibling)
                            btn.parentElement.nextElementSibling.style.display = 'none';
                        });
                        btn.before(btnR);

                        btn.parentElement.firstElementChild.value = inputfile.files[0].name;
                    } else {
                        e.target.nextElementSibling.firstElementChild.value = '';
                    }
                    let select = btn.parentElement.nextElementSibling;
                        // select.style.display = 'none';
                });
            }
        }

        document.forms[0].addEventListener('submit', (e) => {
            
            e.preventDefault();
            let formData = new FormData();
            let inputFiles = document.querySelectorAll('.arco-report');
            for (let i = 0; i < inputFiles.length; i++) {
                if (inputFiles[i].files.length > 0)
                formData.append('arco_report_'+ (i+1), inputFiles[i].files[0]);
            }

            formData.append('arco_salary', document.getElementById('arco-salary').files[0]);
            // post form data
            const xhr = new XMLHttpRequest();
            xhr.responseType = 'json';

            // log response
            xhr.onload = () => {
                if (xhr.readyState === 4) {
                    if (xhr.response) {
                        if (xhr.response.status) {
                        } else {
                        }
                    }
                }
            };

            // create and send the reqeust
            xhr.open('POST', '/upload-correct-arco');
            xhr.send(formData);
            downloadBtn.disabled = true;
            loadingGif.style.opacity = '1';
            downloadingP.textContent = 'Processing...';
            warnings.style.display = 'none';
        });

        function addARCOField(btn) {
            let arcoReportFile = document.querySelectorAll('.arco-report');
            let div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
            <div class="form-group">
                <input type="file" name="arco-report" id="arco-report-${arcoReportFile.length}" class="file-upload-default arco-report" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                <div class="input-group col-xs-12">
                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                    <button class="file-upload-browse btn btn-primary text-white" type="button" onclick="uploadClick(this, 'arco-report-${arcoReportFile.length}')">
                        <i class="ti-file btn-icon-prepend"></i>
                        Upload file
                    </button>
                    <button class="btn btn-info text-white" type="button" onclick="deleteARCOField(this)">
                        <i class="ti-trash"></i>
                    </button>
                </div>
                <select class="form-control mt-1" style="display: none;" id="arco-report-sheetname">
                </select>
            </div>`;
            btn.parentElement.before(div);
        }
        function deleteARCOField(btn) {
            btn.parentElement.parentElement.remove();
        }
    </script>
</div>