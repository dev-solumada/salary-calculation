<div class="content-wrapper">
    <div class="row">
        <div class="col-md-12 grid-margin">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                <h4 class="font-weight-bold mb-0">Programmes <i class="ti-angle-right"></i> Salary calculation</h4>
                </div>
                <div>
                    <!-- <button type="button" class="btn btn-primary btn-icon-text btn-rounded">
                    <i class="ti-clipboard btn-icon-prepend"></i>Report
                    </button> -->
                </div>
            </div>
        </div>
    </div>
    <div class="card" style="min-height: 650px;">
        <form action="/upload-xlsx" enctype="multipart/form-data" method="post">
            <div class="row">
                <div class="col-md-6">
                    <div class="card-body">
                        <h4 class="card-title">RAPPORT RH</h4>
                        <p class="card-description">Field to upload <code>Rapport RH</code> file. The file that contains all the data to be extracted.</p>
                        <div class="template-demo">
                            <div class="form-group">
                                <label>File upload</label>
                                <input type="file" name="rapport-rh" id="rapport-rh" class="file-upload-default" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <div class="input-group col-xs-12">
                                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                                    <button class="file-upload-browse btn btn-primary text-white" type="button" onclick="uploadClick(this, 'rapport-rh')">Upload file</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-body">
                        <h4 class="card-title">GLOBAL SALARY SHEET</h4>
                        <p class="card-description">Field to upload <code>GLOBAL SALARY SHEET</code> file. The file to be filled in with the data extracted.</p>
                        <div class="template-demo">
                            <div class="form-group">
                                <label>File upload</label>
                                <input type="file" name="salary-sheet" id="salary-sheet" class="file-upload-default" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <div class="input-group col-xs-12">
                                    <input type="text" class="form-control file-upload-info" disabled="" placeholder="Upload Microsoft Excel file">
                                    <button class="file-upload-browse btn btn-primary text-white" type="button" role="button" onclick="uploadClick(this, 'salary-sheet')">Upload file</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="card-body">
                        <h4 class="card-title"></h4>
                        <div class="template-demo text-center">
                            <p class="text-muted">Click on the button below to start <code>Data extraction</code> and <code>Download</code> the Excel file.</p>
                            <p class="text-muted">But before that, make sure that you have uploaded the two files.</p>
                            <button type="submit" role="button" class="btn btn-success text-white btn-icon-text" id="download">
                                <i class="ti-download btn-icon-prepend"></i>                                                    
                                Start Data extraction and Download file
                            </button>
                            <div class="text-center">
                                <p class="mt-2 text-dark" style="display: none;" id="downloading-p">Downloading...</p>
                                <img src="/images/loading-gif-15.gif" alt="loading..." draggable="false" id="loading-gif" style="width: 110px;display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script src="js/sweetalert.min.js"></script>
    <script>
        let downloadBtn = document.getElementById('download');
        let loadingGif = document.getElementById('loading-gif');
        let downloadingP = document.getElementById('downloading-p');
        var fileSelected1 = null;
        var fileSelected2 = null;

        function uploadClick(btn, id) {
            let inputfile = document.getElementById(id);
            if (inputfile) {
                inputfile.click();
                inputfile.addEventListener('change', () => {
                    if (inputfile.files.length > 0) {
                        if (id === 'salary-sheet') fileSelected2 = inputfile.files;
                        if (id === 'rapport-rh') fileSelected1 = inputfile.files;
                    } else {
                        if (id === 'salary-sheet') inputfile.files = fileSelected2;
                        if (id === 'rapport-rh') inputfile.files = fileSelected1;
                    }
                    btn.previousElementSibling.value = inputfile.files[0].name;
                    // disable button
                    // downloadBtn.disabled = !(document.getElementById('salary-sheet').files.length === 1 && document.getElementById('rapport-rh').files.length === 1)
                })
            }
        }

        document.forms[0].addEventListener('submit', (e) => {
            e.preventDefault();
            let file1 = document.getElementById('rapport-rh');
            let file2 = document.getElementById('salary-sheet');

            let formData = new FormData();
            formData.append('rh_file', file1.files[0]);
            formData.append('sheet_file', file2.files[0]);

            // post form data
            const xhr = new XMLHttpRequest();
            xhr.responseType = 'json';

            // log response
            xhr.onload = () => {
                if (xhr.response.status) {
                    var link = document.createElement("A");
                    link.setAttribute("href", '/' + xhr.response.file);
                    link.setAttribute("style","display:none");
                    link.setAttribute("download",xhr.response.file);
                    document.body.appendChild(link);                                                        //needed for firefox
                    link.click();
                    // hide loading gif and remove link.
                    downloadingP.style.display = 'inline-block';
                    setInterval(() => {
                        downloadingP.style.display = 'none';
                        link.remove();
                    }, 3000);
                } else {
                    swal({
                        title: new String(xhr.response.icon).toUpperCase(),
                        text: xhr.response.message,
                        icon: xhr.response.icon,
                        type: 'error',
                    })
                }
                downloadBtn.disabled = false;
                loadingGif.style.display = 'none';
            };

            // create and send the reqeust
            xhr.open('POST', '/upload-xlsx');
            xhr.send(formData);
            downloadBtn.disabled = true;
            loadingGif.style.display = 'inline-block';
        })
    </script>
</div>